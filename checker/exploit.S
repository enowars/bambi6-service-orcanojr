# build with:
# $ powerpc-eabi-as -m750cl -mbig --no-pad-sections exploit.S -o exploit.o
# $ powerpc-eabi-ld --oformat=binary -e main -Ttext 0x0 -o exploit.bin exploit.o

.org 0

# SYNC: must be kept in sync with image.elf
.set hostGetNumber, 0x80004be0
.set hostPrintNumber, 0x80004f3c
.set hostComplete, 0x80004f84

.set UID0, 0x01234567
.set UID1, 0x89abcdef

.globl main
main:
	# first
	lis %r3, UID0@h
	ori %r3, %r3, UID0@l
	lis %r4, UID1@h
	ori %r4, %r4, UID1@l
	lis %r5, 0x2000
	ori %r5, %r5, 0x0000

	lis %r6, hostGetNumber@h
	ori %r6, %r6, hostGetNumber@l
	mtctr %r6
	bctrl

	lis %r6, hostPrintNumber@h
	ori %r6, %r6, hostPrintNumber@l
	mtctr %r6
	bctrl

	# second
	lis %r3, UID0@h
	ori %r3, %r3, UID0@l
	lis %r4, UID1@h
	ori %r4, %r4, UID1@l
	lis %r5, 0x2000
	ori %r5, %r5, 0x0001

	lis %r6, hostGetNumber@h
	ori %r6, %r6, hostGetNumber@l
	mtctr %r6
	bctrl

	lis %r6, hostPrintNumber@h
	ori %r6, %r6, hostPrintNumber@l
	mtctr %r6
	bctrl

	lis %r6, hostComplete@h
	ori %r6, %r6, hostComplete@l
	mtctr %r6
	bctrl

hang:
	b hang